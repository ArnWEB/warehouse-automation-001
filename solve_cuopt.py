# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
# SPDX-License-Identifier: Apache-2.0
"""
Basic Routing Server Example

This example demonstrates how to use the cuOpt Self-Hosted Service Client
to solve a simple routing problem via the cuOpt server.

Requirements:
    - cuOpt server running (default: localhost:5000)
    - cuopt_sh_client package installed

Problem:
    - 2 locations (0 and 1)
    - 2 tasks at locations 0 and 1
    - 2 vehicles starting and ending at location [0, 0]

The data is structured according to the OpenAPI specification:
    - cost_matrix_data: Cost matrix indexed by string keys
    - task_data: Task locations
    - fleet_data: Vehicle starting locations

Expected Response:
    {
        "response": {
            "solver_response": {
                "status": 0,
                "num_vehicles": 1,
                "solution_cost": 2.0,
                "vehicle_data": {
                    "0": {
                        "task_id": ["Depot", "0", "1", "Depot"],
                        "route": [0, 0, 1, 0]
                    }
                }
            }
        }
    }
"""

from cuopt_sh_client import CuOptServiceSelfHostClient
import json
import time


def repoll(cuopt_service_client, solution, repoll_tries):
    """
    Repoll the server for solution if it's still processing.

    If solver is still busy solving, the job will be assigned a request id
    and response is sent back in the format {"reqId": <REQUEST-ID>}.
    Solver needs to be re-polled for response using this <REQUEST-ID>.
    """
    if "reqId" in solution and "response" not in solution:
        req_id = solution["reqId"]
        for i in range(repoll_tries):
            solution = cuopt_service_client.repoll(req_id, response_type="dict")
            if "reqId" in solution and "response" in solution:
                break

            # Sleep for a second before requesting
            time.sleep(1)

    return solution


def main():
    """Run the basic routing example with cuOpt server."""
    # Example data for routing problem
    # The data is structured as per the OpenAPI specification for the server
    # data = {
    #     "cost_matrix_data": {"data": {"0": [[0, 1], [1, 0]]}},
    #     "task_data": {"task_locations": [0, 1]},
    #     "fleet_data": {"vehicle_locations": [[0, 0], [0, 0]]},
    # }

    data = {
        "cost_waypoint_graph_data": {
            "waypoint_graph": {
                "0": {
                    "offsets": [
                        0,
                        3,
                        5,
                        10,
                        15,
                        19,
                        21,
                        24,
                        27,
                        33,
                        41,
                        47,
                        50,
                        54,
                        59,
                        63,
                        66,
                        70,
                        75,
                        79,
                        82,
                        85,
                        90,
                        95,
                        97,
                        99,
                        103,
                        108,
                        109,
                        116,
                        119,
                        122,
                        127,
                        129,
                        135,
                        139,
                        145,
                        150,
                        154,
                        155,
                        156,
                        160,
                        164,
                        169,
                        175,
                        180,
                        184,
                        188,
                        189,
                        191,
                        193,
                        195,
                        197,
                        199,
                        202,
                        204,
                        206,
                        208,
                        211,
                        216,
                        220,
                        224,
                        228,
                        233,
                        236,
                        238,
                        240,
                        242,
                        245,
                        247,
                        249,
                        251,
                        253,
                        255,
                        259,
                        264,
                        268,
                        273,
                        277,
                        279,
                        283,
                        288,
                        292,
                        294,
                        295,
                        299,
                        300,
                        304,
                        308,
                        309,
                        313,
                        314,
                    ],
                    "edges": [
                        4,
                        2,
                        3,
                        2,
                        8,
                        0,
                        1,
                        4,
                        9,
                        8,
                        0,
                        5,
                        10,
                        9,
                        4,
                        0,
                        9,
                        3,
                        2,
                        3,
                        10,
                        7,
                        13,
                        18,
                        8,
                        6,
                        13,
                        2,
                        1,
                        9,
                        7,
                        14,
                        13,
                        4,
                        3,
                        2,
                        8,
                        10,
                        15,
                        14,
                        16,
                        5,
                        3,
                        9,
                        16,
                        17,
                        11,
                        17,
                        10,
                        12,
                        11,
                        17,
                        20,
                        21,
                        7,
                        6,
                        14,
                        8,
                        18,
                        13,
                        8,
                        15,
                        9,
                        14,
                        9,
                        16,
                        15,
                        9,
                        10,
                        17,
                        10,
                        16,
                        11,
                        12,
                        21,
                        13,
                        6,
                        19,
                        22,
                        18,
                        23,
                        22,
                        12,
                        21,
                        25,
                        20,
                        24,
                        12,
                        17,
                        25,
                        19,
                        18,
                        23,
                        29,
                        26,
                        19,
                        22,
                        21,
                        25,
                        20,
                        24,
                        21,
                        37,
                        28,
                        22,
                        29,
                        27,
                        40,
                        26,
                        33,
                        29,
                        26,
                        30,
                        40,
                        41,
                        42,
                        28,
                        22,
                        26,
                        31,
                        33,
                        28,
                        34,
                        32,
                        30,
                        33,
                        35,
                        35,
                        31,
                        34,
                        30,
                        28,
                        31,
                        42,
                        43,
                        31,
                        35,
                        33,
                        43,
                        36,
                        32,
                        34,
                        31,
                        43,
                        44,
                        37,
                        35,
                        44,
                        45,
                        46,
                        25,
                        38,
                        46,
                        36,
                        37,
                        40,
                        26,
                        39,
                        41,
                        28,
                        40,
                        28,
                        42,
                        52,
                        28,
                        41,
                        33,
                        43,
                        51,
                        33,
                        42,
                        34,
                        35,
                        44,
                        50,
                        43,
                        35,
                        36,
                        45,
                        49,
                        44,
                        36,
                        46,
                        48,
                        37,
                        47,
                        45,
                        36,
                        46,
                        45,
                        53,
                        44,
                        54,
                        43,
                        55,
                        42,
                        56,
                        41,
                        57,
                        48,
                        87,
                        58,
                        49,
                        59,
                        50,
                        60,
                        51,
                        61,
                        52,
                        62,
                        84,
                        53,
                        87,
                        89,
                        63,
                        59,
                        58,
                        54,
                        60,
                        64,
                        59,
                        55,
                        61,
                        65,
                        60,
                        56,
                        62,
                        66,
                        61,
                        57,
                        84,
                        86,
                        67,
                        58,
                        89,
                        68,
                        59,
                        69,
                        60,
                        70,
                        61,
                        71,
                        62,
                        86,
                        72,
                        63,
                        73,
                        64,
                        74,
                        65,
                        75,
                        66,
                        76,
                        67,
                        77,
                        68,
                        74,
                        78,
                        79,
                        69,
                        73,
                        75,
                        79,
                        80,
                        70,
                        74,
                        76,
                        80,
                        71,
                        75,
                        77,
                        80,
                        81,
                        72,
                        76,
                        81,
                        82,
                        73,
                        79,
                        78,
                        74,
                        73,
                        80,
                        75,
                        79,
                        74,
                        76,
                        81,
                        80,
                        76,
                        77,
                        82,
                        77,
                        81,
                        84,
                        57,
                        83,
                        86,
                        62,
                        86,
                        84,
                        85,
                        62,
                        67,
                        53,
                        88,
                        89,
                        58,
                        87,
                        87,
                        90,
                        58,
                        63,
                        89,
                    ],
                    "weights": [
                        3.0299999713897705,
                        3.7920048236846924,
                        3.8222768306732178,
                        3.0799999237060547,
                        5.119999885559082,
                        3.7920048236846924,
                        3.0799999237060547,
                        2.2799999713897705,
                        5.60471248626709,
                        5.975014686584473,
                        3.8222768306732178,
                        3.4000000953674316,
                        6.146088123321533,
                        5.625237941741943,
                        2.3299999237060547,
                        3.0299999713897705,
                        5.119999885559082,
                        2.3299999237060547,
                        2.2799999713897705,
                        3.4000000953674316,
                        5.119999885559082,
                        5.559999942779541,
                        6.914166450500488,
                        7.510000228881836,
                        3.430000066757202,
                        5.559999942779541,
                        4.110000133514404,
                        5.975014686584473,
                        5.119999885559082,
                        5.360000133514404,
                        3.430000066757202,
                        5.639999866485596,
                        5.3532233238220215,
                        5.119999885559082,
                        5.625237941741943,
                        5.60471248626709,
                        5.360000133514404,
                        5.730000019073486,
                        5.639999866485596,
                        7.780694007873535,
                        8.040056228637695,
                        5.119999885559082,
                        6.146088123321533,
                        5.730000019073486,
                        5.639999866485596,
                        6.4679670333862305,
                        4.21999979019165,
                        4.7530412673950195,
                        4.21999979019165,
                        4.519999980926514,
                        4.519999980926514,
                        6.440885066986084,
                        7.440000057220459,
                        8.01089859008789,
                        4.110000133514404,
                        6.914166450500488,
                        3.7557690143585205,
                        5.3532233238220215,
                        6.517177104949951,
                        3.7557690143585205,
                        5.639999866485596,
                        5.360000133514404,
                        7.780694007873535,
                        5.360000133514404,
                        5.639999866485596,
                        5.730000019073486,
                        5.730000019073486,
                        8.040056228637695,
                        5.639999866485596,
                        4.479308128356934,
                        6.4679670333862305,
                        4.479308128356934,
                        4.7530412673950195,
                        6.440885066986084,
                        3.0233259201049805,
                        6.517177104949951,
                        7.510000228881836,
                        2.880000114440918,
                        1.7999999523162842,
                        2.880000114440918,
                        1.7999999523162842,
                        3.396233320236206,
                        7.440000057220459,
                        2.9700000286102295,
                        1.940000057220459,
                        2.9700000286102295,
                        1.940000057220459,
                        8.01089859008789,
                        3.0233259201049805,
                        3.547463893890381,
                        3.396233320236206,
                        1.7999999523162842,
                        2.880000114440918,
                        4.237924098968506,
                        4.090000152587891,
                        1.7999999523162842,
                        2.880000114440918,
                        1.940000057220459,
                        2.9700000286102295,
                        1.940000057220459,
                        2.9700000286102295,
                        3.547463893890381,
                        4.019999980926514,
                        4.110000133514404,
                        4.090000152587891,
                        3.9221549034118652,
                        2.0899999141693115,
                        4.650000095367432,
                        2.0899999141693115,
                        4.880000114440918,
                        1.8278402090072632,
                        4.110000133514404,
                        5.581979751586914,
                        6.206013202667236,
                        5.0539984703063965,
                        5.820008754730225,
                        1.8278402090072632,
                        4.237924098968506,
                        3.9221549034118652,
                        5.360000133514404,
                        2.7100000381469727,
                        5.581979751586914,
                        2.7100000381469727,
                        5.730000019073486,
                        5.360000133514404,
                        6.006138324737549,
                        6.3385329246521,
                        2.7100000381469727,
                        5.730000019073486,
                        5.360000133514404,
                        2.7100000381469727,
                        4.880000114440918,
                        6.006138324737549,
                        4.8504533767700195,
                        7.095921516418457,
                        2.7100000381469727,
                        5.730000019073486,
                        5.360000133514404,
                        4.650000095367432,
                        2.9600000381469727,
                        2.7100000381469727,
                        5.730000019073486,
                        6.3385329246521,
                        7.379390239715576,
                        4.725261688232422,
                        5.78000020980835,
                        2.9600000381469727,
                        5.110469818115234,
                        5.58860445022583,
                        7.418281555175781,
                        4.019999980926514,
                        2.0299999713897705,
                        4.650000095367432,
                        5.78000020980835,
                        2.0299999713897705,
                        2.0899999141693115,
                        4.650000095367432,
                        2.0899999141693115,
                        2.130000114440918,
                        6.206013202667236,
                        2.130000114440918,
                        5.0539984703063965,
                        5.480000019073486,
                        3.2899999618530273,
                        5.820008754730225,
                        5.480000019073486,
                        4.8504533767700195,
                        6.739999771118164,
                        3.2899999618530273,
                        7.095921516418457,
                        6.739999771118164,
                        4.650000095367432,
                        7.379390239715576,
                        6.570000171661377,
                        3.2899999618530273,
                        6.570000171661377,
                        4.725261688232422,
                        5.110469818115234,
                        5.21999979019165,
                        3.2899999618530273,
                        5.21999979019165,
                        5.58860445022583,
                        2.680000066757202,
                        3.2899999618530273,
                        4.650000095367432,
                        2.0299999713897705,
                        2.680000066757202,
                        7.418281555175781,
                        2.0299999713897705,
                        3.2899999618530273,
                        4.309999942779541,
                        3.2899999618530273,
                        4.309999942779541,
                        3.2899999618530273,
                        4.309999942779541,
                        3.2899999618530273,
                        4.309999942779541,
                        3.2899999618530273,
                        4.309999942779541,
                        4.309999942779541,
                        3.861450433731079,
                        5.179999828338623,
                        4.309999942779541,
                        5.179999828338623,
                        4.309999942779541,
                        5.179999828338623,
                        4.309999942779541,
                        5.179999828338623,
                        4.309999942779541,
                        5.179999828338623,
                        3.549999952316284,
                        5.179999828338623,
                        3.5975546836853027,
                        3.492849826812744,
                        5.340000152587891,
                        5.21999979019165,
                        5.21999979019165,
                        5.179999828338623,
                        6.570000171661377,
                        5.340000152587891,
                        6.570000171661377,
                        5.179999828338623,
                        6.739999771118164,
                        5.340000152587891,
                        6.739999771118164,
                        5.179999828338623,
                        5.480000019073486,
                        5.340000152587891,
                        5.480000019073486,
                        5.179999828338623,
                        3.1642534732818604,
                        3.134788751602173,
                        5.340000152587891,
                        5.340000152587891,
                        4.097853183746338,
                        4.699999809265137,
                        5.340000152587891,
                        4.699999809265137,
                        5.340000152587891,
                        4.699999809265137,
                        5.340000152587891,
                        4.699999809265137,
                        5.340000152587891,
                        3.711940288543701,
                        4.699999809265137,
                        4.699999809265137,
                        3.680000066757202,
                        4.699999809265137,
                        3.680000066757202,
                        4.699999809265137,
                        3.680000066757202,
                        4.699999809265137,
                        3.680000066757202,
                        4.699999809265137,
                        3.680000066757202,
                        3.680000066757202,
                        5.21999979019165,
                        4.630000114440918,
                        6.977485179901123,
                        3.680000066757202,
                        5.21999979019165,
                        6.570000171661377,
                        4.630000114440918,
                        8.037524223327637,
                        3.680000066757202,
                        6.570000171661377,
                        6.739999771118164,
                        4.630000114440918,
                        3.680000066757202,
                        6.739999771118164,
                        5.480000019073486,
                        8.177071571350098,
                        4.630000114440918,
                        3.680000066757202,
                        5.480000019073486,
                        7.174071311950684,
                        4.630000114440918,
                        4.630000114440918,
                        5.21999979019165,
                        5.21999979019165,
                        4.630000114440918,
                        6.977485179901123,
                        6.570000171661377,
                        4.630000114440918,
                        6.570000171661377,
                        8.037524223327637,
                        8.177071571350098,
                        6.739999771118164,
                        6.739999771118164,
                        4.630000114440918,
                        7.174071311950684,
                        5.480000019073486,
                        4.630000114440918,
                        5.480000019073486,
                        2.0899999141693115,
                        3.549999952316284,
                        2.0899999141693115,
                        4.639999866485596,
                        3.1642534732818604,
                        2.0899999141693115,
                        4.639999866485596,
                        2.0899999141693115,
                        3.134788751602173,
                        3.711940288543701,
                        3.861450433731079,
                        2.0299999713897705,
                        4.639999866485596,
                        3.5975546836853027,
                        2.0299999713897705,
                        4.639999866485596,
                        2.0299999713897705,
                        3.492849826812744,
                        4.097853183746338,
                        2.0299999713897705,
                    ],
                }
            }
        },
        "fleet_data": {
            "vehicle_locations": [[0, 0], [0, 7]],
            "capacities": [[11, 11]],
            "vehicle_time_windows": None,
        },
        "task_data": {
            "task_locations": [
                13,
                17,
                19,
                24,
                38,
                47,
                36,
                29,
                39,
                49,
                31,
                55,
                88,
                51,
                85,
                69,
                68,
                70,
                71,
                72,
            ],
            "demand": [[1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]],
            "task_time_windows": None,
            "service_times": None,
        },
        "solver_config": {"time_limit": 0.01},
    }

    # Save waypoint graph to JSON for use by other scripts
    with open("/tmp/cuopt_waypoint_graph.json", "w") as f:
        json.dump(data["cost_waypoint_graph_data"]["waypoint_graph"], f)

    # If cuOpt is not running on localhost:5000, edit ip and port parameters
    cuopt_service_client = CuOptServiceSelfHostClient(
        ip="43.201.55.122", port=5000, polling_timeout=25, timeout_exception=False
    )

    # Submit the routing problem to the server
    solution = cuopt_service_client.get_optimized_routes(data)

    # Number of repoll requests to be carried out for a successful response
    repoll_tries = 500

    # Repoll if needed
    solution = repoll(cuopt_service_client, solution, repoll_tries)

    # Display the solution
    print(json.dumps(solution, indent=4))


if __name__ == "__main__":
    main()
